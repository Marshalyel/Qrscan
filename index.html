<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Scanner Alwaysâ€‘On</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://rawcdn.githack.com/mebjas/html5-qrcode/master/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background: #fafafa; }
    #reader { width: 360px; height: 360px; margin: 20px auto; border: 3px solid lime; border-radius: 8px; background: #000; position: relative; }
    #reader video, #reader canvas { width: 100% !important; height: 100% !important; object-fit: cover; border-radius: 5px; }
    #log { margin-top: 15px; font-size: 16px; color: #333; }
    #log.error { color: #c00; }
  </style>
</head>
<body>
  <h1>QR Tap Scanner</h1>
  <div id="reader"></div>
  <div id="log">ğŸ“· Menunggu QR Codeâ€¦</div>

  <script>
    let html5QrCode;
    let selectedCameraId;

    function setLog(msg, isError = false) {
      const logEl = document.getElementById('log');
      logEl.textContent = msg;
      logEl.classList.toggle('error', isError);
    }

    function onScanSuccess(decodedText) {
      setLog(`âœ… ${new Date().toLocaleTimeString()} â€“ ${decodedText}`);
      html5QrCode.stop()
        .then(() => setTimeout(startScanner, 2000))
        .catch(err => console.error("Error stopping scanner:", err));
    }

    function onScanError(/* errorMessage */) {
      // ignore per-frame errors
    }

    function startScanner() {
      setLog('ğŸ” Mengaktifkan kameraâ€¦');
      html5QrCode.start(
        { deviceId: { exact: selectedCameraId } }, 
        { fps: 10, qrbox: { width:300, height:300 } },
        onScanSuccess,
        onScanError
      )
      .then(() => setLog('ğŸ” Arahkan QR ke kotak kamera'))
      .catch(err => {
        console.error(err);
        setLog(
          err.name === 'NotAllowedError'
            ? 'âŒ Akses kamera ditolak.'
            : `âŒ Gagal mulai kamera: ${err.name || err}`, 
          true
        );
      });
    }

    window.addEventListener('load', () => {
      if (typeof Html5Qrcode !== 'function') {
        setLog('âŒ Library html5â€‘qrcode gagal dimuat.', true);
        return;
      }
      html5QrCode = new Html5Qrcode('reader');

      // Dapatkan daftar kamera, pilih yang belakang (environment)
      Html5Qrcode.getCameras()
        .then(cameras => {
          if (!cameras || cameras.length === 0) {
            setLog('âŒ Tidak ada kamera terdeteksi.', true);
            return;
          }
          // cari kamera dengan label "back" atau ambil yang pertama
          const backCam = cameras.find(cam => /back|rear|environment/i.test(cam.label));
          selectedCameraId = backCam ? backCam.id : cameras[0].id;
          startScanner();
        })
        .catch(err => {
          console.error(err);
          setLog('âŒ Gagal mengambil daftar kamera.', true);
        });
    });
  </script>
</body>
</html>
